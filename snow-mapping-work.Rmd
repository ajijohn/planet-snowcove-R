---
title: "analyze-stuff"
author: "Aji John"
date: "2/23/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

Read the layer
```{r}
library(raster)

darat <- raster::stack('./data/study-area-mm.tiff')
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
darat_predicted <- raster('./data/study-area-predicted.tiff')

aoi <- extent(c(10.02011,10.03,46.58182 ,46.58873 ))
p <- aoi
```

```{r}
library(rgdal)

darat_rg <- readGDAL('./data/study-area-predicted.tiff')
#creates a hige file - Skipping
#writeOGR(darat_rg, layer="band1","data/studyarea.geojson",driver="GeoJSON")

```
```{r}
library(sp)
e <- as(raster::extent(10.02011,10.03,46.58182 ,46.58873), "SpatialPolygons")
proj4string(e) <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"
plot(e)
library(geojson)
asgeojs <- as.geojson(e)

geo_pretty(asgeojs)

```

{
    "type": "FeatureCollection",
    "features": [
        {
            "type": "Feature",
            "id": 0,
            "properties": {
                "dummy": 0.0
            },
            "geometry": {
                "type": "Polygon",
                "coordinates": [
                    [
                        [
                            10.0201,
                            46.5818
                        ],
                        [
                            10.0201,
                            46.5887
                        ],
                        [
                            10.03,
                            46.5887
                        ],
                        [
                            10.03,
                            46.5818
                        ],
                        [
                            10.0201,
                            46.5818
                        ]
                    ]
                ]
            }
        }
    ]
}
 


#visualize
```{r , echo=FALSE}
library('ceramic')

data("wrld_simpl", package = "maptools")
#im <- cc_location(cbind( -107.1661, 38.81874 ), buffer = 1e5, ype = "mapbox.satellite")

aoip<- cc_location(aoi, buffer = 1e5, ype = "mapbox.satellite")
#im <- cc_location(p, ype = "mapbox.terrain-rgb")

#> Preparing to download: 12 tiles at zoom = 6 from 
#> https://api.mapbox.com/v4/mapbox.light/
raster::plotRGB(aoip)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

Plot the area of interest (Bounding box)

class      : Extent 
xmin       : 10.02011 
xmax       : 10.03 
ymin       : 46.58182 
ymax       : 46.58873 


Using ceramic
```{r , echo=FALSE}
library('ceramic')

data("wrld_simpl", package = "maptools")
#im <- cc_location(cbind( -107.1661, 38.81874 ), buffer = 1e5, ype = "mapbox.satellite")

im <- cc_location(p, buffer = 1e5, ype = "mapbox.satellite")
#im <- cc_location(p, ype = "mapbox.terrain-rgb")

#> Preparing to download: 12 tiles at zoom = 6 from 
#> https://api.mapbox.com/v4/mapbox.light/
raster::plotRGB(im)
```

# Clip the prediction



# Clip the ASO


Clip the canopy


```{r , echo=FALSE}

df <- raster::stack('data/newstudy.tif')
data_matrix <- rasterToPoints(df)
head(data_matrix)
datafra_comb <- data_matrix %>% as.data.frame()

colnames(datafra_comb) <- c('x','y','aso','pred','veg_height')
```

```{r , echo=FALSE}
library(tidyverse)
library(rasterVis)

gplot(df[[3]]) + 
  geom_tile(aes(fill = value))  +
 viridis::scale_fill_viridis(direction = -1, na.value='#FFFFFF00') + 
  theme_bw()

ggsave(filename = "figs/swiss_canopyheightmap.png",dpi = 300,height=4,width=8,units="in")
```

```{r , echo=FALSE}
library(caret)
datafra_comb1m <- datafra_comb %>% dplyr::filter(!is.na(veg_height) & veg_height > 2) %>% as.data.frame()

high_veg <- datafra_comb1m %>% dplyr::filter(!is.na(veg_height)) %>% dplyr::filter(veg_height > 1 ) %>% as.data.frame()
high_veg_df <- high_veg %>% dplyr::mutate(pred_f = as.factor(pred),aso_f = as.factor(aso)) %>% as.data.frame()

confusionMatrix(as.factor(high_veg$aso),as.factor(high_veg$pred),mode = 'prec_recall')

```

```{r , echo=FALSE}
library(caret)

low_veg <- datafra_comb %>%  dplyr::filter(veg_height < 2 ) %>% as.data.frame()
low_veg_df <- low_veg %>% dplyr::mutate(pred_f = as.factor(pred),aso_f = as.factor(aso)) %>% as.data.frame()

confusionMatrix(as.factor(low_veg$aso),as.factor(low_veg$pred),mode = 'prec_recall')

```

```{r , echo=FALSE}
library(caret)

bare_veg <- datafra_comb %>%  dplyr::filter(veg_height < 1 ) %>% as.data.frame()
bare_veg_df <- bare_veg %>% dplyr::mutate(pred_f = as.factor(pred),aso_f = as.factor(aso)) %>% as.data.frame()

confusionMatrix(as.factor(bare_veg$aso),as.factor(bare_veg$pred),mode = 'prec_recall')

```





```{r , echo=FALSE}
lin <- function(x){x * 10 + 0.6}

# TPI for different neighborhood size:
tpiw <- function(x, w=5) {
	m <- matrix(1/(w^2-1), nc=w, nr=w)
	m[ceiling(0.5 * length(m))] <- 0
	f <- focal(x, m)
	x - f
}

cd <- function(x, w) {
	m <- matrix(1, nc=w, nr=w)
#	m[ceiling(0.5 * length(m))] <- 0
	f <- focal(x, m, fun=sum)
	f
}

```


```{r , echo=FALSE}
library(tidyverse)
library(rasterVis)
# 225m2
#canden5by5wc <- cd(split_chm1, w=5)
#canden3by3wc <- cd(chm_crop, w=3)

#rcwc <- reclassify(canden3by3wc, c(0, 50, 100,150, 200, 250))

#gplot(rcwc) + 
#  geom_tile(aes(fill = value))  +
# viridis::scale_fill_viridis(direction = -1, na.value='#FFFFFF00') + 
#  theme_bw()

#ggsave(filename = "figs/wc_densitymap.png",dpi = 300,height=4,width=8,units="in")
```
## Reclassify the canopy height layer

```{r , echo=FALSE}

#m <- c(-10, 2, 0,  2, 100, 1)
#rclmat <- matrix(m, ncol=3, byrow=TRUE)
#r_chm <- reclassify(chm_crop, rclmat)

cdensity <- function(x, w) {
	m <- matrix(1, nc=w, nr=w)
#	m[ceiling(0.5 * length(m))] <- 0
	f <- focal(x, m, fun=mean)
	f
}

# 225m2
#canden5by5wc <- cd(split_chm1, w=5)
```

```{r , echo=FALSE}
df_cd <- raster::stack('data/newstudywithcd.tif')
data_matrix_cd <- rasterToPoints(df_cd)
head(data_matrix_cd)
datafra_comb_cd <- data_matrix_cd %>% as.data.frame()

colnames(datafra_comb_cd) <- c('x','y','aso','pred','can_den')
```

# plot canopy density
```{r , echo=FALSE}
library(tidyverse)
library(rasterVis)

gplot(df_cd[[3]]) + 
  geom_tile(aes(fill = value))  +
 viridis::scale_fill_viridis(direction = -1, na.value='#FFFFFF00') + 
  theme_bw()

ggsave(filename = "figs/swiss_densitymap.png",dpi = 300,height=4,width=8,units="in")
```


```{r , echo=FALSE}
library(caret)
datafra_comb1m_cd <- datafra_comb_cd %>% dplyr::filter(!is.na(can_den) & can_den > .75) %>% as.data.frame()

dense_veg <- datafra_comb1m_cd %>% dplyr::filter(!is.na(can_den)) %>% dplyr::filter(can_den > .75 ) %>% as.data.frame()
dense_veg_df <- dense_veg %>% dplyr::mutate(pred_f = as.factor(pred),aso_f = as.factor(aso)) %>% as.data.frame()

confusionMatrix(as.factor(dense_veg$aso),as.factor(dense_veg$pred),mode = 'prec_recall')

```

```{r , echo=FALSE}
library(caret)
datafra_comb1m_cd <- datafra_comb_cd %>% dplyr::filter(!is.na(can_den) & can_den > .5 & can_den < .75) %>% as.data.frame()

dense_veg <- datafra_comb1m_cd %>% dplyr::filter(!is.na(can_den)) %>% dplyr::filter(  can_den > .5 & can_den < .75 ) %>% as.data.frame()


confusionMatrix(as.factor(dense_veg$aso),as.factor(dense_veg$pred),mode = 'prec_recall')

```

```{r , echo=FALSE}
library(caret)
datafra_comb1m_cd <- datafra_comb_cd %>% dplyr::filter(!is.na(can_den) & can_den < .5) %>% as.data.frame()

dense_veg <- datafra_comb1m_cd %>% dplyr::filter(!is.na(can_den)) %>% dplyr::filter(can_den < .5 ) %>% as.data.frame()

confusionMatrix(as.factor(dense_veg$aso),as.factor(dense_veg$pred),mode = 'prec_recall')

```


Look at DCe

Plot the DCE Metrics

```{r , echo=FALSE}
df_dce <- raster::stack('data/newstudywithdce.tif')
```

```{r , echo=FALSE}

data_matrix_dce <- rasterToPoints(df_dce)
head(data_matrix_dce)
datafra_comb_dce <- data_matrix_dce %>% as.data.frame()

colnames(datafra_comb_dce) <- c('x','y','aso','pred','dce')
datafra_comb_orig <- datafra_comb_dce
```
# Plot DCE
```{r , echo=FALSE}
library(tidyverse)
library(rasterVis)

gplot(df_dce[[3]]) + 
  geom_tile(aes(fill = value))  +
 viridis::scale_fill_viridis(direction = -1, na.value='#FFFFFF00') + 
  theme_bw()

ggsave(filename = "figs/swiss_dcemap.png",dpi = 300,height=4,width=8,units="in")
```

```{r , echo=FALSE}
library(caret)
datafra_comb_dce <- datafra_comb_orig %>% dplyr::filter(!is.na(dce) & dce <0) %>% as.data.frame()

dense_dce<- datafra_comb_dce %>% dplyr::filter(!is.na(dce)) %>% dplyr::filter(dce < 0 ) %>% as.data.frame()


confusionMatrix(as.factor(dense_dce$aso),as.factor(dense_dce$pred),mode = 'prec_recall')

```


```{r , echo=FALSE}
library(caret)
datafra_comb_dce <- datafra_comb_orig %>% dplyr::filter(!is.na(dce) & dce >0  & dce < 30) %>% as.data.frame()

med_dce<- datafra_comb_dce %>% dplyr::filter(!is.na(dce)) %>% dplyr::filter(dce >0  & dce < 30) %>% as.data.frame()


confusionMatrix(as.factor(med_dce$aso),as.factor(med_dce$pred),mode = 'prec_recall')

```

```{r , echo=FALSE}
library(caret)
datafra_comb_dce <- datafra_comb_orig %>% dplyr::filter(!is.na(dce) & dce > 30) %>% as.data.frame()

low_dce<- datafra_comb_dce %>% dplyr::filter(!is.na(dce)) %>% dplyr::filter( dce > 30) %>% as.data.frame()


confusionMatrix(as.factor(low_dce$aso),as.factor(low_dce$pred),mode = 'prec_recall')

```